<script>

    let txtUsusario=document.getElementById('txtUsusario');
    let txtPasword=document.getElementById('txtPasword');
    let spanLogin=document.getElementById('spanLogin');
    let btnLogin=document.getElementById('btnLogin');
    let divLogin=document.getElementById('divLogin');
    let btnRegistrarse = document.getElementById('btnRegistrarse');
    let divRegistrar=document.getElementById('divRegistrar');
    let btnRegistro=document.getElementById('btnRegistro');
    let btnVolverRegistrarse=document.getElementById('btnVolverRegistrarse');

    let txtNombre=document.getElementById('txtNombre');
    let sltTipoDoc=document.getElementById('sltTipoDoc');
    let txtNumeroDocumento=document.getElementById('txtNumeroDocumento');
    let txtCorreo=document.getElementById('txtCorreo');
    let txtTelefono=document.getElementById('txtTelefono');
    let sltRoles=document.getElementById('sltRoles');
    let txtUsuarioRegister=document.getElementById('txtUsuarioRegister');
    let txtPaswordRegister=document.getElementById('txtPaswordRegister');
    let spnNumDoc=document.getElementById('spnNumDoc');

    document.addEventListener("DOMContentLoaded",async function () {
        await traerRoles();
        await traerTiposDocumento();
    });

    async function traerTiposDocumento(){
        let url = `@Url.Action("consultarTiposDocumento", "Home")`;
        let r = await Get(url);
        sltTipoDoc.innerHTML=`<option value="0">Seleccione tipo de documento...</option>`;
        r.forEach(el=>{
            sltTipoDoc.innerHTML+=`<option value="${el.id}">${el.descripcion}</option>`;
        });
    }

    async function traerRoles(){
        let url = `@Url.Action("consultarRoles", "Login")`;
        let r = await Get(url);
        sltRoles.innerHTML=`<option value="0">Seleccione rol...</option>`;
        r.forEach(el=>{
            sltRoles.innerHTML+=`<option value="${el.id}">${el.descripcion}</option>`;
        });
    }

    function limpiarLogin(){
        $(txtUsusario).val('');
        $(txtPasword).val('');
    }


    function limpiarRegistro(){
        $(txtNombre).val('');
        $(sltTipoDoc).val('');
        $(txtNumeroDocumento).val('');
        $(txtUsuarioRegister).val('');
        $(txtPaswordRegister).val('');
        $(txtCorreo).val('');
        $(txtTelefono).val('');
        $(sltRoles).val('0');
    }

    async function validarNumDoc(){
        let url = `@Url.Action("ValidarNumDoc", "Login")` + `?numDoc=${$(txtNumeroDocumento).val()}`;
        let r = await Get(url);
        if(r.login){
            return true;
        }
        ocultarElemento(spnNumDoc, false);
        return false;
    }

    txtUsusario.addEventListener('change', function(){
        ocultarElemento(spanLogin, true);
    });
    
    txtPasword.addEventListener('change', function(){
        ocultarElemento(spanLogin, true);
    });

    btnLogin.addEventListener('click', async function(){
        let login = {
            'usuario':$(txtUsusario).val(),
            'contrasena':$(txtPasword).val()
        };
        let url = `@Url.Action("Autenticar", "Login")`;
        let r = await Get(url, {'usuario': login});
        if(r.login){
            url= `@Url.Action("Home", "Home")` + `?idUsuario=${r.idUsuario}`;
            window.location = url
            return
        }
        spanLogin.innerHTML=r.mensaje;
        ocultarElemento(spanLogin, false);
        limpiarLogin()
    });

    btnRegistrarse.addEventListener('click', function(){
        limpiarLogin();
        ocultarElemento(spanLogin, true);
        ocultarElemento(divLogin, true);
        ocultarElemento(divRegistrar, false);
    });

    btnRegistro.addEventListener('click', async function(){
        
        if(await validarNumDoc()){
            var dato={
                "nombre":$(txtNombre).val(),
                "tipoDocumento":$(sltTipoDoc).val(),
                "numeroDocumento":$(txtNumeroDocumento).val(),
                "login":$(txtUsuarioRegister).val(),
                "contraseña":$(txtPaswordRegister).val(),
                "correo":$(txtCorreo).val(),
                "telefono":$(txtTelefono).val(),
                "idRol":parseInt($(sltRoles).val())
            }
            let url = `@Url.Action("RegistrarUsuario", "Login")`;
            let r = await Get(url, {'usuario': dato});
            if(r.mensaje=='se creo usuario'){
                ocultarElemento(divLogin, false);
                ocultarElemento(divRegistrar, true);
                limpiarRegistro();
            }
        }
    })

    btnVolverRegistrarse.addEventListener('click', function(){
        ocultarElemento(divLogin, false);
        ocultarElemento(divRegistrar, true);
        limpiarRegistro();
    })

    txtNumeroDocumento.addEventListener('change', function(){
        ocultarElemento(spnNumDoc, true);
    })

    function validarContrasenna(e){
        
        var tecla = (document.all) ? e.keyCode : e.which;

        //Tecla de retroceso para borrar, siempre la permite
        if (tecla == 8) {
            return true;
        }

        // Patrón de entrada, en este caso solo acepta numeros y letras
        var patron = /[A-Za-z0-9]/;
        var tecla_final = String.fromCharCode(tecla);
        return patron.test(tecla_final);
    }

</script>
